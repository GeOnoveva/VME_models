---
title: "R Notebook"
output: html_notebook
---

# Intro

This script can be run as soon as environmental layers for new areas are available, i.e. without the MarVid data yet ready. Requires running "1_Predictors" first, and for the names not to change


# Libraries
```{r}
library(raster)
library(rgdal)
```

# Select model
```{r}
model <- modelfin
```

# Predictions
```{r}
# list of factor levels

f1 <- levels(v$landscape)
f2 <- levels(v$sedclass)
f3 <- levels(v$seddan)
f4 <- levels(v$sedmil)

f <- list(f1,f2, f3, f4)

names(f) <-c("landscape", "sedclass", "seddan", "sedmil" )

predfun <- function(m, d, ...) predict(m, newdata=d, ...)

#pc <- raster::predict(pred, model, OOB=TRUE, factors=f, fun=predfun)

## same, in parallel

beginCluster()
pc <- clusterR(pred,
               predict,
               args=list(model=model,
                         OOB=TRUE,
                         factors=f,
                         fun=predfun,
                         index=1:2)) # index=1?
pc <- pc[[1]]
```

# Save output
```{r}
#writeRaster(pc,file.path(outdatapath, paste0("Prediction", response, ".tif", collapse = NULL)), options="INTERLEAVE=BAND", overwrite=TRUE)
```

# Using spatial pixels instead
```{r}
vme.rfd1 <- predict(m1, cbind(
  resp.dist0@data, 
  pred.pix@data), 
                     type="quantiles", quantiles=quantiles)$predictions
## now more computational...
pred.pix$vme_dens = vme.rfd1[,2]
## s.d. of the prediction error:
pred.pix$vme_dens_var = (vme.rfd1[,3]-vme.rfd1[,1])/2
str(pred.pix@data)
```

# visualize
```{r qrf-sic97-maps, echo=FALSE, fig.width=9, fig.cap="Predictions and prediction errors for the SIC97 data set."}
par(mfrow=c(1,2), oma=c(0,0,0,0.5), mar=c(0,0,1.5,1))
plot(raster(pred.pix["vme_dens"]), col=leg, 
     main="Random Forest (RF)", axes=FALSE, box=FALSE)
points(resp_spat, pch="+")
plot(raster(pred.pix["vme_dens_var"]), col=rev(bpy.colors()), 
     main="Random Forest (RF) prediction error", axes=FALSE, box=FALSE)
points(resp_spat, pch="+")
```

# save outputs
```{r}
writeGDAL(swiss1km["rainfall_rfd1"], fname = "../RF_vs_kriging/results/rainfall/pred_rainfall_RFsp.tif", options = c("COMPRESS=DEFLATE"))
writeGDAL(swiss1km["rainfall_rfd1_var"], fname = "../RF_vs_kriging/results/rainfall/pred.var_rainfall_RFsp.tif", options = c("COMPRESS=DEFLATE"))

```


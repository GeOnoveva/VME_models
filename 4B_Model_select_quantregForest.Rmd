---
title: "R Notebook"
output: html_notebook
---

# Libraries
```{r}
library(quantregForest)
```
# Using the quantregForest library

```{r}

# train
Ytrain = v_train %>%
  select(vmeind_density) %>% pull
Xtrain <- v_train %>% select(6:dim(v_train)[2])
  #%>% rescl5_260
qrf <- quantregForest(x=Xtrain, y=Ytrain)

Xtest = v_test %>% select(6:dim(v_test)[2])

predicted <- predict(qrf, Xtest, what=mean)
observed <- v_test %>%
  select(vmeind_density)
idx <- which(is.na(pull(data.frame(unlist(predicted)))))
vecv <- vecv(pull(observed)[-idx],pull(data.frame(unlist(predicted)))[-idx]) # variance explained by cross-validation, conservative estimate to report
vecv
```
# Another approach (using ranger)

```{r}
library(ranger)
qrf2<-ranger(fmla0, v_train, mtry=5,  min.node.size=2, sample.fraction=0.9930754, num.trees=500, # these parameters need to have been fined-tuned on a previous step
                   importance="impurity", seed=1, quantreg= TRUE)
qrf2
```

```{r}
xl <- as.list(ranger::importance(qrf2))
print(t(data.frame(xl[order(unlist(xl), decreasing=TRUE)[1:10]])))
```

```{r}

quantiles = c((1-.682)/2, 0.5, 1-(1-.682)/2)

vme.qrf2 <- predict(qrf2, cbind(
  #swiss.dist0@data, 
  v_test), 
                     type="quantiles", quantiles=quantiles)$predictions
## now more computational...
v_test$vme.qrf2pr = vme.qrf2[,2]
## s.d. of the prediction error:
v_test$vme.qrf2var = (vme.qrf2[,3]-vme.qrf2[,1])/2
head(v_test)
```
```{r}
predicted <- v_test$vme.qrf2pr
observed <- v_test %>%
  select(vmeind_density)

vecv <- vecv(pull(observed),pull(data.frame(unlist(predicted)))) # variance explained by cross-validation, conservative estimate to report
vecv

```


---
title: "Cut and vectorize"
output: html_notebook
---

# Intro

inputs: pc
outputs:

# Libraries
```{r}
library(terra)
library(dplyr)
#library(spatialEco)
library(Ckmeans.1d.dp)
```

# Inputs
```{r}
distribution <- rast(file.path(outpath, paste(vme,"minus", paste(remove, collapse=", "), "pred.tif")))
errorr <- rast(file.path(outpath, paste(vme,"minus", paste(remove, collapse=", "), "pred var.tif")))

# Substract
distribution[errorr>quantile(values(errorr, na.rm=TRUE))[4]]<-NA
```

# Threshold
```{r}
#val <- values(distribution, na.rm=TRUE) %>% data.frame %>% pull
#th <- getJenksBreaks(val, 1)

# discret<-data.frame( class=Ckmeans.1d.dp(val, k=2)$cluster, value=val)
# th <- max(discret$value[which(discret$class==1)])

th<-Ckmeans.1d.dp(val, k=2)$centers[2]
```

# Vectorize
```{r}
mna <- 8000*8000
mxh <- 8000*800

rcl <- matrix(data = c(0,thresvalue,thresvalue,max(values(raster), na.rm =TRUE),0,1), nrow=2)
rec <- reclassify(raster, rcl, include.lowest = TRUE)
pol <- rasterToPolygons(rec, fun=function(x){x==1}, dissolve = TRUE)
#pol <- as(spatialEco::explode(pol), "Spatial")
pol<-sf::st_cast(as(pol, "sf"))
pol<- as(pol, "Spatial")
pol$area_sqkm <- area(pol) / 1000000
pol <- pol[pol$area_sqkm>min.area,]
area_thresh <- units::set_units(max.hole, km^2)
pol <- smoothr::fill_holes(pol, threshold = area_thresh)
pol <- smoothr::smooth(pol, method = "ksmooth")

#pol <- threspol(th, raster(distribution), mna, mxh)
```

# Save outputs
```{r}
terra::writeRaster(distribution, file.path(outpath, paste(vme,"minus", paste(remove, collapse=", "), "pred cert.tif")), filetype = "GTiff", overwrite = TRUE)

writeOGR(pol, outpath, paste(vme,"minus", paste(remove, collapse=", "), "polygon"), driver="ESRI Shapefile")
```
